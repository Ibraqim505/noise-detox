{% extends "base.html" %}

{% block title %}–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª—É—Ö–∞ - –®—É–º–æ–≤–æ–π –¥–µ—Ç–æ–∫—Å{% endblock %}

{% block content %}
<div style="margin-top: 80px; padding: 3rem 2rem;">
    <div class="container">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h1 class="section-title">üëÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª—É—Ö–∞</h1>
            <p class="section-subtitle">
                –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª—É—Ö–∞ –ø–æ–º–æ–≥–∞–µ—Ç –≤–æ–≤—Ä–µ–º—è –∑–∞–º–µ—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </p>
        </div>

        <div style="max-width: 900px; margin: 0 auto;">
            <!-- –í–≤–µ–¥–µ–Ω–∏–µ -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1rem;">–û —Ç–µ—Å—Ç–µ —Å–ª—É—Ö–∞</h2>
                <p style="margin-bottom: 1rem;">
                    –°–ª—É—Ö ‚Äî —ç—Ç–æ –ø–µ—Ä–≤–æ–µ, —á—Ç–æ —Å—Ç—Ä–∞–¥–∞–µ—Ç –æ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —à—É–º–∞. –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ 
                    –ø–æ–º–æ–≥–∞–µ—Ç –≤–æ–≤—Ä–µ–º—è –∑–∞–º–µ—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏.
                </p>
                <p style="color: var(--color-text-secondary);">
                    –î–ª—è —Ç–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ª—É—Ö–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ç–∞–∫–∏–µ –∫–∞–∫ 
                    <strong>"–®—É–º–∞—Ö–µ—Ä"</strong> –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ 
                    –∑–≤—É–∫–æ–≤ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç–æ—Ç–∞—Ö.
                </p>
            </div>

            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1.5rem;">üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</h2>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; font-size: 1.2rem;">1Ô∏è‚É£ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</h3>
                    <ul style="line-height: 2; color: var(--color-text-secondary);">
                        <li>–ù–∞–π–¥–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–∏—Ö–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ</li>
                        <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞—É—à–Ω–∏–∫–∏</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –≤—ã —Å–ø–æ–∫–æ–π–Ω—ã –∏ –æ—Ç–¥–æ—Ö–Ω—É–ª–∏</li>
                        <li>–í—ã–∫–ª—é—á–∏—Ç–µ –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ —à—É–º–∞</li>
                    </ul>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; font-size: 1.2rem;">2Ô∏è‚É£ –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞</h3>
                    <ul style="line-height: 2; color: var(--color-text-secondary);">
                        <li>–°–∫–∞—á–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ª—É—Ö–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–®—É–º–∞—Ö–µ—Ä")</li>
                        <li>–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</li>
                        <li>–ß–µ—Å—Ç–Ω–æ –æ—Ç–º–µ—á–∞–π—Ç–µ, —Å–ª—ã—à–∏—Ç–µ –ª–∏ –≤—ã –∑–≤—É–∫</li>
                        <li>–ù–µ –≤–∫–ª—é—á–∞–π—Ç–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∞ –º–∞–∫—Å–∏–º—É–º</li>
                    </ul>
                </div>

                <div>
                    <h3 style="margin-bottom: 1rem; font-size: 1.2rem;">3Ô∏è‚É£ –§–∏–∫—Å–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</h3>
                    <ul style="line-height: 2; color: var(--color-text-secondary);">
                        <li>–ó–∞–ø–∏—à–∏—Ç–µ –¥–∞—Ç—É —Ç–µ—Å—Ç–∞</li>
                        <li>–û—Ç–º–µ—Ç—å—Ç–µ –æ–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</li>
                        <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ (–µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç)</li>
                    </ul>
                </div>
            </div>

            <!-- –í–∞–∂–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ -->
            <div class="warning-box">
                <h3 style="margin-bottom: 0.75rem;">‚ö†Ô∏è –í–∞–∂–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ</h3>
                <p>
                    –î–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, <strong>–Ω–µ —è–≤–ª—è—é—Ç—Å—è 
                    –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –¥–∏–∞–≥–Ω–æ–∑–æ–º</strong> –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö 
                    —Ü–µ–ª—è—Ö –¥–ª—è —Å–∞–º–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è. –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å–æ —Å–ª—É—Ö–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ 
                    –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É-–æ—Ç–æ–ª–∞—Ä–∏–Ω–≥–æ–ª–æ–≥—É.
                </p>
            </div>

            <!-- –§–æ—Ä–º–∞ –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
            <div class="card" style="margin-top: 2rem;">
                <h2 style="margin-bottom: 1.5rem;">üìù –ó–∞–ø–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞</h2>
                
                <form id="hearingTestForm">
                    <div class="form-group">
                        <label class="form-label">üìÖ –î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞</label>
                        <input type="date" id="testDate" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üìä –û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</label>
                        <select id="result" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç...</option>
                            <option value="excellent">‚≠ê –û—Ç–ª–∏—á–Ω—ã–π —Å–ª—É—Ö</option>
                            <option value="normal">‚úÖ –ù–æ—Ä–º–∞</option>
                            <option value="slight">‚ö†Ô∏è –ù–µ–±–æ–ª—å—à–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è</option>
                            <option value="moderate">‚ùó –£–º–µ—Ä–µ–Ω–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ</option>
                            <option value="significant">üö® –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üéß –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
                        <input type="text" id="frequencies" class="form-input" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≤—ã—Å–æ–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã, 8000 –ì—Ü">
                    </div>

                    <div class="form-group">
                        <label class="form-label">üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è</label>
                        <textarea id="testNotes" class="form-textarea" 
                                  placeholder="–õ—é–±—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∏–ª–∏ –¥–µ—Ç–∞–ª–∏ —Ç–µ—Å—Ç–∞..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    </button>
                </form>
            </div>

            <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
            <div class="info-box" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —á–∞—Å—Ç–æ—Ç–µ –ø—Ä–æ–≤–µ—Ä–æ–∫</h3>
                <ul style="line-height: 2;">
                    <li><strong>–ü–µ—Ä–≤—ã–π —Ç–µ—Å—Ç</strong> ‚Äî –≤ –Ω–∞—á–∞–ª–µ –ø—Ä–æ–µ–∫—Ç–∞ (–±–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è)</li>
                    <li><strong>–ü–æ–≤—Ç–æ—Ä–Ω—ã–π —Ç–µ—Å—Ç</strong> ‚Äî —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π</li>
                    <li><strong>–ü—Ä–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–∏ –≥—Ä–æ–º–∫–æ–≥–æ —à—É–º–∞</strong> ‚Äî –∫–∞–∂–¥—ã–µ 2 –Ω–µ–¥–µ–ª–∏</li>
                    <li><strong>–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞</strong> ‚Äî —Ä–∞–∑ –≤ 3-6 –º–µ—Å—è—Ü–µ–≤</li>
                </ul>
            </div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤ -->
            <div style="margin-top: 3rem;">
                <h2 class="section-title">–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤</h2>
                <div id="testHistory"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
document.getElementById('testDate').value = new Date().toISOString().split('T')[0];

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
document.getElementById('hearingTestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const test = {
        testDate: document.getElementById('testDate').value,
        result: document.getElementById('result').value,
        frequencies: document.getElementById('frequencies').value,
        notes: document.getElementById('testNotes').value
    };
    
    db.addHearingTest(test);
    Notification.success('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    
    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    this.reset();
    document.getElementById('testDate').value = new Date().toISOString().split('T')[0];
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
    loadTestHistory();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤
function loadTestHistory() {
    const tests = db.getHearingTests().reverse();
    const container = document.getElementById('testHistory');
    
    if (tests.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">–í—ã –µ—â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Ç–µ—Å—Ç—ã. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –≤—ã—à–µ!</p>';
        return;
    }
    
    const resultNames = {
        excellent: '‚≠ê –û—Ç–ª–∏—á–Ω—ã–π —Å–ª—É—Ö',
        normal: '‚úÖ –ù–æ—Ä–º–∞',
        slight: '‚ö†Ô∏è –ù–µ–±–æ–ª—å—à–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ',
        moderate: '‚ùó –£–º–µ—Ä–µ–Ω–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ',
        significant: 'üö® –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏'
    };
    
    const resultColors = {
        excellent: '#34c759',
        normal: '#34c759',
        slight: '#ff9f0a',
        moderate: '#ff9f0a',
        significant: '#ff453a'
    };
    
    container.innerHTML = tests.map((test, index) => `
        <div class="card" style="margin-bottom: 1rem; border-left: 4px solid ${resultColors[test.result]};">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                    <h3 style="margin-bottom: 0.5rem;">–¢–µ—Å—Ç #${tests.length - index}</h3>
                    <p style="color: var(--color-text-secondary);">
                        ${DateUtils.formatDate(test.testDate)}
                    </p>
                </div>
                <button onclick="deleteTest('${test.id}')" class="btn" style="padding: 0.5rem; background: transparent; color: var(--color-danger);">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <div style="background: var(--color-bg-subtle); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ${resultNames[test.result]}
            </div>
            
            ${test.frequencies ? `
                <div style="margin-bottom: 1rem;">
                    <strong>–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã:</strong> ${test.frequencies}
                </div>
            ` : ''}
            
            ${test.notes ? `
                <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <strong>–ó–∞–º–µ—Ç–∫–∏:</strong><br>
                    <em style="color: var(--color-text-secondary);">${test.notes}</em>
                </div>
            ` : ''}
        </div>
    `).join('');
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤
    if (tests.length >= 2) {
        const comparison = document.createElement('div');
        comparison.className = 'info-box';
        comparison.style.marginTop = '2rem';
        
        const first = tests[tests.length - 1];
        const last = tests[0];
        
        const resultValues = {
            excellent: 5,
            normal: 4,
            slight: 3,
            moderate: 2,
            significant: 1
        };
        
        const diff = resultValues[last.result] - resultValues[first.result];
        let message = '';
        
        if (diff > 0) {
            message = '<strong style="color: #34c759;">üìà –£–ª—É—á—à–µ–Ω–∏–µ!</strong> –í–∞—à —Å–ª—É—Ö –ø–æ–∫–∞–∑–∞–ª –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é –¥–∏–Ω–∞–º–∏–∫—É.';
        } else if (diff < 0) {
            message = '<strong style="color: #ff453a;">üìâ –£—Ö—É–¥—à–µ–Ω–∏–µ</strong> –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∏–∑–∏—Ç—å –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ —à—É–º–∞ –∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É.';
        } else {
            message = '<strong>‚û°Ô∏è –°—Ç–∞–±–∏–ª—å–Ω–æ</strong> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ —Ç–æ–º –∂–µ —É—Ä–æ–≤–Ω–µ.';
        }
        
        comparison.innerHTML = `
            <h3 style="margin-bottom: 1rem;">üìä –î–∏–Ω–∞–º–∏–∫–∞</h3>
            <p>${message}</p>
            <p style="margin-top: 1rem; color: var(--color-text-secondary);">
                –ü–µ—Ä–≤—ã–π —Ç–µ—Å—Ç (${DateUtils.formatDate(first.testDate)}): ${resultNames[first.result]}<br>
                –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Å—Ç (${DateUtils.formatDate(last.testDate)}): ${resultNames[last.result]}
            </p>
        `;
        
        container.appendChild(comparison);
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
function deleteTest(id) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ—Å—Ç?')) {
        const tests = db.getHearingTests().filter(t => t.id !== id);
        localStorage.setItem('noise_detox_hearing', JSON.stringify(tests));
        Notification.success('–¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω');
        loadTestHistory();
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
document.addEventListener('DOMContentLoaded', loadTestHistory);
</script>
{% endblock %}
