{% extends "base.html" %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã - –®—É–º–æ–≤–æ–π –¥–µ—Ç–æ–∫—Å{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div style="margin-top: 80px; padding: 3rem 2rem;">
    <div class="container">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h1 class="section-title">üìä –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h1>
            <p class="section-subtitle">
                –ê–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è —à—É–º–∞ –Ω–∞ –≤–∞—à–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ
            </p>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
        <div class="card" style="margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: 600;">–ü–µ—Ä–∏–æ–¥:</label>
                <button class="btn btn-secondary" onclick="setPeriod(7)">7 –¥–Ω–µ–π</button>
                <button class="btn btn-secondary" onclick="setPeriod(14)">14 –¥–Ω–µ–π</button>
                <button class="btn btn-secondary" onclick="setPeriod(30)">30 –¥–Ω–µ–π</button>
                <button class="btn btn-secondary" onclick="setPeriod('all')">–í—Å—ë –≤—Ä–µ–º—è</button>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="statsCards" style="margin-bottom: 3rem;"></div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="chart-container">
            <h2 class="chart-title">üìà –£—Ä–æ–≤–µ–Ω—å —à—É–º–∞ –ø–æ –¥–Ω—è–º</h2>
            <canvas id="noiseChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">üéØ –ì–¥–µ —è —á–∞—â–µ –≤—Å–µ–≥–æ —Å—Ç–∞–ª–∫–∏–≤–∞—é—Å—å —Å —à—É–º–æ–º</h2>
            <canvas id="locationChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">üòä –°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –∏ —à—É–º</h2>
            <canvas id="wellbeingChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">üí§ –í–ª–∏—è–Ω–∏–µ —à—É–º–∞ –Ω–∞ —Å–æ–Ω</h2>
            <div id="sleepAnalysis"></div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">üéß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—É—à–Ω–∏–∫–æ–≤</h2>
            <canvas id="headphonesChart"></canvas>
        </div>

        <!-- –í—ã–≤–æ–¥—ã -->
        <div id="conclusions" style="margin-top: 3rem;"></div>

        <!-- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö -->
        <div class="card" style="margin-top: 3rem;">
            <h2 style="margin-bottom: 1.5rem;">üíæ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="exportDataToJSON()">
                    <i class="fas fa-download"></i>
                    –°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (JSON)
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                    <i class="fas fa-upload"></i>
                    –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
                <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(this)">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPeriod = 7;
let charts = {};

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–∏–æ–¥–∞
function setPeriod(days) {
    currentPeriod = days;
    loadResults();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function loadResults() {
    const allEntries = db.getDiaryEntries();
    
    if (allEntries.length === 0) {
        document.getElementById('statsCards').innerHTML = `
            <div class="info-box">
                <h3>–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                <p>–ù–∞—á–Ω–∏—Ç–µ –≤–µ—Å—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞!</p>
                <a href="/diary" class="btn btn-primary" style="margin-top: 1rem;">
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–Ω–µ–≤–Ω–∏–∫—É
                </a>
            </div>
        `;
        return;
    }
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–µ—Ä–∏–æ–¥—É
    let entries = allEntries;
    if (currentPeriod !== 'all') {
        const cutoffDate = DateUtils.getDaysAgo(currentPeriod);
        entries = allEntries.filter(e => new Date(e.timestamp) >= cutoffDate);
    }
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    displayStats(entries);
    
    // –ì—Ä–∞—Ñ–∏–∫–∏
    displayNoiseChart(entries);
    displayLocationChart(entries);
    displayWellbeingChart(entries);
    displaySleepAnalysis(entries);
    displayHeadphonesChart(entries);
    
    // –í—ã–≤–æ–¥—ã
    displayConclusions(entries);
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function displayStats(entries) {
    const noiseStats = DataAnalyzer.getNoiseStats(entries);
    const totalEntries = entries.length;
    const highNoiseCount = noiseStats.loud + noiseStats.veryLoud;
    const highNoisePercent = ((highNoiseCount / totalEntries) * 100).toFixed(1);
    
    const wellbeingStats = DataAnalyzer.getWellbeingStats(entries);
    const badWellbeingCount = wellbeingStats.headache + wellbeingStats.irritated + wellbeingStats.tinnitus;
    const badWellbeingPercent = ((badWellbeingCount / totalEntries) * 100).toFixed(1);
    
    const headphonesCount = entries.filter(e => e.headphones !== 'none').length;
    const headphonesPercent = ((headphonesCount / totalEntries) * 100).toFixed(1);
    
    document.getElementById('statsCards').innerHTML = `
        <div class="cards-grid">
            <div class="card">
                <span class="card-icon">üìù</span>
                <h3 class="card-title">${totalEntries}</h3>
                <p class="card-text">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
            </div>
            <div class="card">
                <span class="card-icon">üî¥</span>
                <h3 class="card-title">${highNoisePercent}%</h3>
                <p class="card-text">–î–Ω–µ–π —Å —Å–∏–ª—å–Ω—ã–º —à—É–º–æ–º</p>
            </div>
            <div class="card">
                <span class="card-icon">üò£</span>
                <h3 class="card-title">${badWellbeingPercent}%</h3>
                <p class="card-text">–°–ª—É—á–∞–µ–≤ –ø–ª–æ—Ö–æ–≥–æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è</p>
            </div>
            <div class="card">
                <span class="card-icon">üéß</span>
                <h3 class="card-title">${headphonesPercent}%</h3>
                <p class="card-text">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—É—à–Ω–∏–∫–æ–≤</p>
            </div>
        </div>
    `;
}

// –ì—Ä–∞—Ñ–∏–∫ —É—Ä–æ–≤–Ω—è —à—É–º–∞
function displayNoiseChart(entries) {
    const data = DataAnalyzer.getDailyNoiseData(entries, currentPeriod === 'all' ? 30 : currentPeriod);
    
    const ctx = document.getElementById('noiseChart');
    
    if (charts.noise) {
        charts.noise.destroy();
    }
    
    charts.noise = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.date),
            datasets: [{
                label: '–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å —à—É–º–∞',
                data: data.map(d => d.avgNoise),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 4,
                    ticks: {
                        callback: function(value) {
                            const labels = ['', '–¢–∏—Ö–æ', '–£–º–µ—Ä–µ–Ω–Ω–æ', '–®—É–º–Ω–æ', '–û—á–µ–Ω—å —à—É–º–Ω–æ'];
                            return labels[value] || '';
                        }
                    }
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫ –º–µ—Å—Ç
function displayLocationChart(entries) {
    const locations = {};
    entries.forEach(e => {
        locations[e.location] = (locations[e.location] || 0) + 1;
    });
    
    const locationNames = {
        home: '–î–æ–º',
        school: '–®–∫–æ–ª–∞',
        street: '–£–ª–∏—Ü–∞',
        transport: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
        concert: '–ö–æ–Ω—Ü–µ—Ä—Ç',
        other: '–î—Ä—É–≥–æ–µ'
    };
    
    const ctx = document.getElementById('locationChart');
    
    if (charts.location) {
        charts.location.destroy();
    }
    
    charts.location = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(locations).map(l => locationNames[l]),
            datasets: [{
                data: Object.values(locations),
                backgroundColor: [
                    '#667eea',
                    '#764ba2',
                    '#f093fb',
                    '#4facfe',
                    '#43e97b',
                    '#fa709a'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è
function displayWellbeingChart(entries) {
    const stats = DataAnalyzer.getWellbeingStats(entries);
    
    const wellbeingNames = {
        good: '–ë–æ–¥—Ä–æ—Å—Ç—å',
        tired: '–£—Å—Ç–∞–ª–æ—Å—Ç—å',
        headache: '–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å',
        irritated: '–†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ',
        sleepy: '–°–æ–Ω–ª–∏–≤–æ—Å—Ç—å',
        tinnitus: '–ó–≤–æ–Ω –≤ —É—à–∞—Ö'
    };
    
    const ctx = document.getElementById('wellbeingChart');
    
    if (charts.wellbeing) {
        charts.wellbeing.destroy();
    }
    
    charts.wellbeing = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(stats).map(w => wellbeingNames[w]),
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª—É—á–∞–µ–≤',
                data: Object.values(stats),
                backgroundColor: [
                    '#34c759',
                    '#ff9f0a',
                    '#ff453a',
                    '#ff453a',
                    '#ff9f0a',
                    '#ff453a'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// –ê–Ω–∞–ª–∏–∑ —Å–Ω–∞
function displaySleepAnalysis(entries) {
    const sleepEntries = entries.filter(e => e.sleep && e.sleep !== '');
    
    if (sleepEntries.length === 0) {
        document.getElementById('sleepAnalysis').innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ —Å–Ω–µ</p>';
        return;
    }
    
    const sleepQuality = {
        good: 0,
        longFalling: 0,
        waking: 0,
        insomnia: 0
    };
    
    sleepEntries.forEach(e => {
        if (sleepQuality.hasOwnProperty(e.sleep)) {
            sleepQuality[e.sleep]++;
        }
    });
    
    const sleepNames = {
        good: 'üò¥ –•–æ—Ä–æ—à–∏–π —Å–æ–Ω',
        longFalling: 'üòï –î–æ–ª–≥–æ –∑–∞—Å—ã–ø–∞–ª',
        waking: 'üòñ –ü—Ä–æ—Å—ã–ø–∞–ª—Å—è –Ω–æ—á—å—é',
        insomnia: 'üò´ –ë–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞'
    };
    
    const total = sleepEntries.length;
    
    document.getElementById('sleepAnalysis').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            ${Object.entries(sleepQuality).map(([key, count]) => {
                const percent = ((count / total) * 100).toFixed(1);
                return `
                    <div style="text-align: center; padding: 1.5rem; background: var(--color-bg-subtle); border-radius: 12px;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">${sleepNames[key]}</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--color-primary);">${percent}%</div>
                        <div style="color: var(--color-text-secondary);">${count} –∏–∑ ${total}</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

// –ì—Ä–∞—Ñ–∏–∫ –Ω–∞—É—à–Ω–∏–∫–æ–≤
function displayHeadphonesChart(entries) {
    const headphones = {
        none: 0,
        less1: 0,
        '1-3': 0,
        more3: 0
    };
    
    entries.forEach(e => {
        if (headphones.hasOwnProperty(e.headphones)) {
            headphones[e.headphones]++;
        }
    });
    
    const headphonesNames = {
        none: '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª',
        less1: '–î–æ 1 —á–∞—Å–∞',
        '1-3': '1-3 —á–∞—Å–∞',
        more3: '–ë–æ–ª–µ–µ 3 —á–∞—Å–æ–≤'
    };
    
    const ctx = document.getElementById('headphonesChart');
    
    if (charts.headphones) {
        charts.headphones.destroy();
    }
    
    charts.headphones = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(headphones).map(h => headphonesNames[h]),
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π',
                data: Object.values(headphones),
                backgroundColor: ['#34c759', '#ff9f0a', '#ff9f0a', '#ff453a']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// –í—ã–≤–æ–¥—ã
function displayConclusions(entries) {
    const noiseStats = DataAnalyzer.getNoiseStats(entries);
    const wellbeingStats = DataAnalyzer.getWellbeingStats(entries);
    const correlation = DataAnalyzer.getNoiseWellbeingCorrelation(entries);
    
    const conclusions = [];
    
    // –ê–Ω–∞–ª–∏–∑ —à—É–º–∞
    const highNoiseCount = noiseStats.loud + noiseStats.veryLoud;
    if (highNoiseCount > entries.length * 0.3) {
        conclusions.push({
            icon: 'üî¥',
            title: '–í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —à—É–º–∞',
            text: `–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –≤—ã ${highNoiseCount} —Ä–∞–∑ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å –≤ —É—Å–ª–æ–≤–∏—è—Ö —Å–∏–ª—å–Ω–æ–≥–æ —à—É–º–∞. –≠—Ç–æ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${((highNoiseCount / entries.length) * 100).toFixed(1)}% –æ—Ç –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π.`,
            type: 'warning'
        });
    }
    
    // –ê–Ω–∞–ª–∏–∑ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è
    const badWellbeingCount = wellbeingStats.headache + wellbeingStats.irritated + wellbeingStats.tinnitus;
    if (badWellbeingCount > entries.length * 0.2) {
        conclusions.push({
            icon: 'üò£',
            title: '–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º',
            text: `–í ${((badWellbeingCount / entries.length) * 100).toFixed(1)}% —Å–ª—É—á–∞–µ–≤ –≤—ã –æ—Ç–º–µ—á–∞–ª–∏ –≥–æ–ª–æ–≤–Ω—É—é –±–æ–ª—å, —Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ –∑–≤–æ–Ω –≤ —É—à–∞—Ö.`,
            type: 'warning'
        });
    }
    
    // –ê–Ω–∞–ª–∏–∑ –Ω–∞—É—à–Ω–∏–∫–æ–≤
    const headphonesHigh = entries.filter(e => e.headphones === 'more3' || e.headphones === '1-3').length;
    if (headphonesHigh > entries.length * 0.3) {
        conclusions.push({
            icon: 'üéß',
            title: '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—É—à–Ω–∏–∫–æ–≤',
            text: `–í–Ω–∏–º–∞–Ω–∏–µ! –í—ã —á–∞—Å—Ç–æ —Å–ª—É—à–∞–µ—Ç–µ –º—É–∑—ã–∫—É –≤ –Ω–∞—É—à–Ω–∏–∫–∞—Ö –±–æ–ª–µ–µ 1 —á–∞—Å–∞ –≤ –¥–µ–Ω—å. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∞—Å–Ω–æ –¥–ª—è —Å–ª—É—Ö–∞.`,
            type: 'warning'
        });
    }
    
    // –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è
    const veryLoudBad = correlation.veryLoud.bad;
    const veryLoudTotal = correlation.veryLoud.good + correlation.veryLoud.bad;
    if (veryLoudTotal > 0 && veryLoudBad / veryLoudTotal > 0.5) {
        conclusions.push({
            icon: 'üìä',
            title: '–°–≤—è–∑—å –º–µ–∂–¥—É —à—É–º–æ–º –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º',
            text: `–í –¥–Ω–∏ —Å –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º —à—É–º–∞ –≤—ã —á–∞—â–µ –æ—Ç–º–µ—á–∞–ª–∏ –ø–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ (${((veryLoudBad / veryLoudTotal) * 100).toFixed(1)}% —Å–ª—É—á–∞–µ–≤).`,
            type: 'info'
        });
    }
    
    // –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã
    if (noiseStats.quiet > entries.length * 0.4) {
        conclusions.push({
            icon: '‚úÖ',
            title: '–•–æ—Ä–æ—à–∞—è —à—É–º–æ–≤–∞—è –≥–∏–≥–∏–µ–Ω–∞',
            text: `–û—Ç–ª–∏—á–Ω–æ! –ë–æ–ª—å—à—É—é —á–∞—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ —Ç–∏—Ö–æ–π —Å—Ä–µ–¥–µ.`,
            type: 'success'
        });
    }
    
    const container = document.getElementById('conclusions');
    
    if (conclusions.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = `
        <h2 class="section-title">üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã</h2>
        ${conclusions.map(c => `
            <div class="${c.type === 'warning' ? 'warning-box' : 'info-box'}" style="margin-bottom: 1rem;">
                <h3 style="margin-bottom: 0.75rem;">${c.icon} ${c.title}</h3>
                <p>${c.text}</p>
            </div>
        `).join('')}
    `;
}

// –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
function handleImport(input) {
    if (input.files && input.files[0]) {
        importDataFromJSON(input.files[0]);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
document.addEventListener('DOMContentLoaded', () => {
    loadResults();
});
</script>
{% endblock %}
