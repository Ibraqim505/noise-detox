{% extends "base.html" %}

{% block title %}–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π - –®—É–º–æ–≤–æ–π –¥–µ—Ç–æ–∫—Å{% endblock %}

{% block content %}
<div style="margin-top: 80px; padding: 3rem 2rem;">
    <div class="container">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h1 class="section-title">üìù –î–Ω–µ–≤–Ω–∏–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π</h1>
            <p class="section-subtitle">
                –ó–∞–ø–æ–ª–Ω—è–π—Ç–µ –¥–Ω–µ–≤–Ω–∏–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–ª–∏—è–Ω–∏–µ —à—É–º–∞ –Ω–∞ –≤–∞—à–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ
            </p>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–Ω–µ–≤–Ω–∏–∫–∞ -->
        <div style="max-width: 800px; margin: 0 auto;">
            <div class="card">
                <form id="diaryForm">
                    <!-- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è -->
                    <div class="form-group">
                        <label class="form-label">üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                        <input type="datetime-local" id="datetime" class="form-input" required>
                    </div>

                    <!-- –ú–µ—Å—Ç–æ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è -->
                    <div class="form-group">
                        <label class="form-label">üìç –ú–µ—Å—Ç–æ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è</label>
                        <select id="location" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ...</option>
                            <option value="home">üè† –î–æ–º</option>
                            <option value="school">üè´ –®–∫–æ–ª–∞/–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</option>
                            <option value="street">üö∂ –£–ª–∏—Ü–∞</option>
                            <option value="transport">üöå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                            <option value="concert">üéµ –ö–æ–Ω—Ü–µ—Ä—Ç/–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</option>
                            <option value="other">‚öôÔ∏è –î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <div class="form-group" id="otherLocationGroup" style="display: none;">
                        <label class="form-label">–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ</label>
                        <input type="text" id="otherLocation" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä">
                    </div>

                    <!-- –£—Ä–æ–≤–µ–Ω—å —à—É–º–∞ -->
                    <div class="form-group">
                        <label class="form-label">üîä –£—Ä–æ–≤–µ–Ω—å —à—É–º–∞</label>
                        <div class="noise-levels">
                            <div class="noise-level">
                                <input type="radio" name="noiseLevel" id="quiet" value="quiet" required>
                                <label for="quiet">
                                    <span class="noise-icon">üü¢</span>
                                    <span class="noise-label">–¢–∏—Ö–æ</span>
                                    <small style="color: var(--color-text-light); font-size: 0.85rem;">–ú–æ–∂–Ω–æ —É—Å–ª—ã—à–∞—Ç—å —à—ë–ø–æ—Ç</small>
                                </label>
                            </div>
                            <div class="noise-level">
                                <input type="radio" name="noiseLevel" id="moderate" value="moderate">
                                <label for="moderate">
                                    <span class="noise-icon">üü°</span>
                                    <span class="noise-label">–£–º–µ—Ä–µ–Ω–Ω–æ</span>
                                    <small style="color: var(--color-text-light); font-size: 0.85rem;">–û–±—ã—á–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä</small>
                                </label>
                            </div>
                            <div class="noise-level">
                                <input type="radio" name="noiseLevel" id="loud" value="loud">
                                <label for="loud">
                                    <span class="noise-icon">üü†</span>
                                    <span class="noise-label">–®—É–º–Ω–æ</span>
                                    <small style="color: var(--color-text-light); font-size: 0.85rem;">–ü—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –ø–æ–≤—ã—à–∞—Ç—å –≥–æ–ª–æ—Å</small>
                                </label>
                            </div>
                            <div class="noise-level">
                                <input type="radio" name="noiseLevel" id="veryLoud" value="veryLoud">
                                <label for="veryLoud">
                                    <span class="noise-icon">üî¥</span>
                                    <span class="noise-label">–û—á–µ–Ω—å —à—É–º–Ω–æ</span>
                                    <small style="color: var(--color-text-light); font-size: 0.85rem;">–¢—Ä—É–¥–Ω–æ —Ä–∞—Å—Å–ª—ã—à–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
                    <div class="form-group">
                        <label class="form-label">‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è</label>
                        <select id="duration" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å...</option>
                            <option value="less30">–ú–µ–Ω–µ–µ 30 –º–∏–Ω—É—Ç</option>
                            <option value="30-60">30-60 –º–∏–Ω—É—Ç</option>
                            <option value="1-3">1-3 —á–∞—Å–∞</option>
                            <option value="more3">–ë–æ–ª–µ–µ 3 —á–∞—Å–æ–≤</option>
                        </select>
                    </div>

                    <!-- –°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ -->
                    <div class="form-group">
                        <label class="form-label">üòä –§–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)</label>
                        <div class="emoji-checkboxes">
                            <div class="emoji-checkbox">
                                <input type="checkbox" id="good" name="wellbeing" value="good">
                                <label for="good">
                                    <span class="emoji-icon">üòÉ</span>
                                    <span>–ë–æ–¥—Ä–æ—Å—Ç—å</span>
                                </label>
                            </div>
                            <div class="emoji-checkbox">
                                <input type="checkbox" id="tired" name="wellbeing" value="tired">
                                <label for="tired">
                                    <span class="emoji-icon">üòê</span>
                                    <span>–£—Å—Ç–∞–ª–æ—Å—Ç—å</span>
                                </label>
                            </div>
                            <div class="emoji-checkbox">
                                <input type="checkbox" id="headache" name="wellbeing" value="headache">
                                <label for="headache">
                                    <span class="emoji-icon">üò£</span>
                                    <span>–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å</span>
                                </label>
                            </div>
                            <div class="emoji-checkbox">
                                <input type="checkbox" id="irritated" name="wellbeing" value="irritated">
                                <label for="irritated">
                                    <span class="emoji-icon">üò§</span>
                                    <span>–†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ</span>
                                </label>
                            </div>
                            <div class="emoji-checkbox">
                                <input type="checkbox" id="sleepy" name="wellbeing" value="sleepy">
                                <label for="sleepy">
                                    <span class="emoji-icon">üò¥</span>
                                    <span>–°–æ–Ω–ª–∏–≤–æ—Å—Ç—å</span>
                                </label>
                            </div>
                            <div class="emoji-checkbox">
                                <input type="checkbox" id="tinnitus" name="wellbeing" value="tinnitus">
                                <label for="tinnitus">
                                    <span class="emoji-icon">üëÇ</span>
                                    <span>–ó–≤–æ–Ω –≤ —É—à–∞—Ö</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è -->
                    <div class="form-group">
                        <label class="form-label">üéØ –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≤–Ω–∏–º–∞–Ω–∏—è</label>
                        <select id="concentration" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            <option value="easy">‚úÖ –õ–µ–≥–∫–æ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è</option>
                            <option value="moderate">‚ö†Ô∏è –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–≤–ª–µ–∫–∞—é—Å—å</option>
                            <option value="hard">‚ùå –û—á–µ–Ω—å —Ç—Ä—É–¥–Ω–æ —Å–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</option>
                        </select>
                    </div>

                    <!-- –ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ -->
                    <div class="form-group">
                        <label class="form-label">üò¥ –ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ (–¥–ª—è –≤–µ—á–µ—Ä–Ω–µ–π –∑–∞–ø–∏—Å–∏)</label>
                        <select id="sleep" class="form-select">
                            <option value="">–ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ</option>
                            <option value="good">üò¥ –ë—ã—Å—Ç—Ä–æ –∑–∞—Å–Ω—É–ª(–∞), —Å–ø–∞–ª(–∞) –∫—Ä–µ–ø–∫–æ</option>
                            <option value="longFalling">üòï –î–æ–ª–≥–æ –∑–∞—Å—ã–ø–∞–ª(–∞)</option>
                            <option value="waking">üòñ –ß–∞—Å—Ç–æ –ø—Ä–æ—Å—ã–ø–∞–ª—Å—è(–∞) –Ω–æ—á—å—é</option>
                            <option value="insomnia">üò´ –ë–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞</option>
                        </select>
                    </div>

                    <!-- –ù–∞—É—à–Ω–∏–∫–∏ -->
                    <div class="form-group">
                        <label class="form-label">üéß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—É—à–Ω–∏–∫–æ–≤</label>
                        <select id="headphones" class="form-select" required>
                            <option value="none">–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª(–∞)</option>
                            <option value="less1">–î–æ 1 —á–∞—Å–∞</option>
                            <option value="1-3">1-3 —á–∞—Å–∞</option>
                            <option value="more3">–ë–æ–ª–µ–µ 3 —á–∞—Å–æ–≤</option>
                        </select>
                    </div>

                    <div class="form-group" id="volumeGroup" style="display: none;">
                        <label class="form-label">–ì—Ä–æ–º–∫–æ—Å—Ç—å</label>
                        <select id="volume" class="form-select">
                            <option value="low">–ù–∏–∑–∫–∞—è</option>
                            <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                            <option value="high">–í—ã—Å–æ–∫–∞—è</option>
                        </select>
                    </div>

                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ -->
                    <div class="form-group">
                        <label class="form-label">üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea id="notes" class="form-textarea" placeholder="–õ—é–±—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è..."></textarea>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i>
                            –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
            <div style="margin-top: 3rem;">
                <h2 class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h2>
                <div id="recentEntries"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
document.getElementById('datetime').value = new Date().toISOString().slice(0, 16);

// –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –¥–ª—è "–î—Ä—É–≥–æ–µ" –º–µ—Å—Ç–æ
document.getElementById('location').addEventListener('change', function() {
    const otherGroup = document.getElementById('otherLocationGroup');
    otherGroup.style.display = this.value === 'other' ? 'block' : 'none';
});

// –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–∞—É—à–Ω–∏–∫–æ–≤
document.getElementById('headphones').addEventListener('change', function() {
    const volumeGroup = document.getElementById('volumeGroup');
    volumeGroup.style.display = this.value !== 'none' ? 'block' : 'none';
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
document.getElementById('diaryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const wellbeingChecks = Array.from(document.querySelectorAll('input[name="wellbeing"]:checked'))
        .map(cb => cb.value);
    
    if (wellbeingChecks.length === 0) {
        Notification.error('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è');
        return;
    }
    
    const entry = {
        datetime: document.getElementById('datetime').value,
        location: document.getElementById('location').value,
        otherLocation: document.getElementById('otherLocation').value,
        noiseLevel: document.querySelector('input[name="noiseLevel"]:checked').value,
        duration: document.getElementById('duration').value,
        wellbeing: wellbeingChecks,
        concentration: document.getElementById('concentration').value,
        sleep: document.getElementById('sleep').value,
        headphones: document.getElementById('headphones').value,
        volume: document.getElementById('volume').value,
        notes: document.getElementById('notes').value
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    db.addDiaryEntry(entry);
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    Notification.success('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    setTimeout(() => {
        resetForm();
        loadRecentEntries();
    }, 500);
});

// –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
function resetForm() {
    document.getElementById('diaryForm').reset();
    document.getElementById('datetime').value = new Date().toISOString().slice(0, 16);
    document.getElementById('otherLocationGroup').style.display = 'none';
    document.getElementById('volumeGroup').style.display = 'none';
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π
function loadRecentEntries() {
    const entries = db.getDiaryEntries().slice(-5).reverse();
    const container = document.getElementById('recentEntries');
    
    if (entries.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –≤—ã—à–µ!</p>';
        return;
    }
    
    container.innerHTML = entries.map(entry => {
        const locationNames = {
            home: 'üè† –î–æ–º',
            school: 'üè´ –®–∫–æ–ª–∞',
            street: 'üö∂ –£–ª–∏—Ü–∞',
            transport: 'üöå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
            concert: 'üéµ –ö–æ–Ω—Ü–µ—Ä—Ç',
            other: `‚öôÔ∏è ${entry.otherLocation || '–î—Ä—É–≥–æ–µ'}`
        };
        
        const noiseLevelNames = {
            quiet: 'üü¢ –¢–∏—Ö–æ',
            moderate: 'üü° –£–º–µ—Ä–µ–Ω–Ω–æ',
            loud: 'üü† –®—É–º–Ω–æ',
            veryLoud: 'üî¥ –û—á–µ–Ω—å —à—É–º–Ω–æ'
        };
        
        return `
            <div class="card" style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div>
                        <strong>${DateUtils.formatDateTime(entry.timestamp)}</strong>
                        <br>
                        <span style="color: var(--color-text-secondary);">${locationNames[entry.location]}</span>
                    </div>
                    <button onclick="deleteEntry('${entry.id}')" class="btn" style="padding: 0.5rem; background: transparent; color: var(--color-danger);">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <strong>–®—É–º:</strong> ${noiseLevelNames[entry.noiseLevel]}
                    </div>
                    <div>
                        <strong>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:</strong> ${entry.wellbeing.join(', ')}
                    </div>
                </div>
                ${entry.notes ? `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;"><em>${entry.notes}</em></div>` : ''}
            </div>
        `;
    }).join('');
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
function deleteEntry(id) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
        db.deleteDiaryEntry(id);
        Notification.success('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
        loadRecentEntries();
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', loadRecentEntries);
</script>
{% endblock %}
